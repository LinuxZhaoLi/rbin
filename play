#!/usr/bin/c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <assert.h>
#include <libgen.h>

void ensure_bin(const char *bin) {
    char *cmd = NULL;
    const char *root = "&>/dev/null hash ";

    cmd = malloc(strlen(root) + strlen(bin) + 1);
    strcat(cmd, root);
    strcat(cmd, bin);

    if (system(cmd)) {
        fprintf(stderr, "error: %s wasn't found in $PATH\n", bin);
        exit(1);
    }
}

int main(int argc, char **argv) {
    if (argc == 1) {
        fprintf(stderr, "usage: %s <search terms...>\n", basename(argv[0]));
        return 1;
    }

    ensure_bin("mpv");
    ensure_bin("youtube-dl");

    char *cmd = NULL;
    const char *ytdl = "youtube-dl --default-search=auto '";
    cmd = malloc(strlen(ytdl) + 1);
    assert(cmd);
    strcat(cmd, ytdl);

    for (int i = 1; i < argc; i++) {
        cmd = realloc(cmd, strlen(cmd) + strlen(argv[i]) + 1);
        assert(cmd);
        strcat(cmd, argv[i]);
        strcat(cmd, " ");
    }
    cmd[strlen(cmd)-1] = '\0';
    strcat(cmd, "' -o - | mpv -");

    return system(cmd);
}

/* vim: set syntax=c cindent: */
